<script>
  document.querySelectorAll(".carousel").forEach((carousel) => {
    const sources = Array.from(carousel.querySelectorAll(".carousel-sources img"))
      .map(img => img.getAttribute("src"));

    const centerImg = carousel.querySelector(".carousel-center-img");
    const centerArea = carousel.querySelector(".carousel-center");
    const leftStackEl = carousel.querySelector(".carousel-stack.left");
    const rightStackEl = carousel.querySelector(".carousel-stack.right");

    const btnLeft = carousel.querySelector(".carousel-btn.left");
    const btnRight = carousel.querySelector(".carousel-btn.right");

    // Piles: left / center / right
    let center = 0;
    let leftStack = [];
    let rightStack = sources.map((_, i) => i).slice(1); // initial queue on right

    function renderStacks() {
      leftStackEl.innerHTML = "";
      rightStackEl.innerHTML = "";

      // render left stack
      leftStack.forEach((idx, i) => {
        const card = document.createElement("div");
        card.className = "stack-card";
        card.style.setProperty("--stack-i", String(i));
        const img = document.createElement("img");
        img.src = sources[idx];
        img.alt = "";
        card.appendChild(img);
        leftStackEl.appendChild(card);
      });

      // render right stack
      rightStack.forEach((idx, i) => {
        const card = document.createElement("div");
        card.className = "stack-card";
        card.style.setProperty("--stack-i", String(i));
        const img = document.createElement("img");
        img.src = sources[idx];
        img.alt = "";
        card.appendChild(img);
        rightStackEl.appendChild(card);
      });

      centerImg.src = sources[center];

      // Keep your existing arrow enable/disable logic
      // (adjust if your current behavior differs)
      btnLeft.disabled = rightStack.length === 0; // left pulls from RIGHT
      btnRight.disabled = leftStack.length === 0; // right pulls from LEFT
    }

    // ACTIONS (these match your current arrow behavior)
    function moveLeft() {
      // left arrow: pull from RIGHT into center; center goes to LEFT
      if (rightStack.length === 0) return;
      leftStack.unshift(center);
      center = rightStack.shift();
      renderStacks();
    }

    function moveRight() {
      // right arrow: pull from LEFT into center; center goes to RIGHT
      if (leftStack.length === 0) return;
      rightStack.unshift(center);
      center = leftStack.shift();
      renderStacks();
    }

    // Arrows
    btnLeft.addEventListener("click", (e) => { e.stopPropagation(); moveLeft(); });
    btnRight.addEventListener("click", (e) => { e.stopPropagation(); moveRight(); });

    // ===== Drag / swipe support =====
    let dragging = false;
    let startX = 0;
    let lastX = 0;

    const THRESHOLD_PX = 40; // how far you must drag to trigger a move

    function onDown(e) {
      // Only drag when overlay isn't active (optional safety)
      const overlay = carousel.closest(".glow-card-inner")?.querySelector(".work-overlay");
      if (overlay && overlay.classList.contains("active")) return;

      dragging = true;
      startX = e.clientX;
      lastX = startX;

      centerArea.setPointerCapture(e.pointerId);
    }

    function onMove(e) {
      if (!dragging) return;
      lastX = e.clientX;
      // (Optional: you can add a tiny visual "tug" here later)
    }

    function onUp(e) {
      if (!dragging) return;
      dragging = false;

      const dx = lastX - startX;

      // Drag left (dx negative) means user swiped left: show next from RIGHT (moveLeft)
      if (dx <= -THRESHOLD_PX) {
        moveLeft();
        return;
      }

      // Drag right (dx positive) means user swiped right: show next from LEFT (moveRight)
      if (dx >= THRESHOLD_PX) {
        moveRight();
        return;
      }

      // small drag: do nothing
    }

    centerArea.addEventListener("pointerdown", onDown);
    centerArea.addEventListener("pointermove", onMove);
    centerArea.addEventListener("pointerup", onUp);
    centerArea.addEventListener("pointercancel", onUp);

    renderStacks();
  });
</script>
